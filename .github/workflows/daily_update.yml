name: Daily Weather Check

on:
  schedule:
    # 毎日 7:30 JST = 前日 22:30 UTC
    - cron: '30 22 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 pytz playwright
        playwright install chromium --with-deps

    - name: Run logic
      run: |
        python src/main.py

    - name: Generate Screenshot and Env
      run: |
        python src/screenshot.py

    - name: Debug ENV
      run: |
        echo "RESULT_TEXT: ${{ env.RESULT_TEXT }}"
        echo "UPDATED_AT: ${{ env.UPDATED_AT }}"
        echo "P3D: ${{ env.P3D }}"
        echo "P30D: ${{ env.P30D }}"

    - name: Commit and Push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/data.json docs/data.js data/history.csv
        git commit -m "Update weather data and screenshot" || exit 0
        git push

    - name: Send mail
      if: success() && env.RESULT_TEXT != ''
      uses: dawidd6/action-send-mail@v4
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{secrets.MAIL_USERNAME}}
        password: ${{secrets.MAIL_PASSWORD}}
        subject: "【気象条件自動判定システム】${{env.RESULT_TEXT}} (${{env.UPDATED_AT}})"
        to: shou-yobou@city.kitakyushu.lg.jp
        from: "気象条件自動判定システム <${{secrets.MAIL_USERNAME}}>"
        secure: true
        body: |
          関係各位

          気象条件自動判定システムの結果をお知らせします。

          ■判定日時: ${{env.UPDATED_AT}}
          ■判定結果: 【${{env.RESULT_TEXT}}】

          ＜詳細データ＞
          ・前3日間の降水量合計: ${{env.P3D}} mm
          ・前30日間の降水量合計: ${{env.P30D}} mm
          ・乾燥注意報: ${{env.ADVISORY_DRY}}
          ・強風注意報: ${{env.WIND_TEXT}}

          詳細なデータおよび過去の履歴については、以下のWEBサイトをご確認ください。
          URL: https://ryo0905jumpih-sys.github.io/kitakyuushuusi/

          ※このメールはシステムからの自動送信です。
        attachments: screenshot.png
