<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—é‡ç«ç½æ°—è±¡æ¡ä»¶ è‡ªå‹•åˆ¤å®šãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header>
            <h1>æ°—è±¡æ¡ä»¶è‡ªå‹•åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="location-selector">
                <select id="location-select">
                    <option value="" disabled selected>åœ°ç‚¹ã‚’é¸æŠ...</option>
                </select>
            </div>
            <p class="subtitle" id="subtitle">è¦³æ¸¬åœ°ç‚¹ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</p>
        </header>

        <main>
            <div id="result-card" class="card result-card loading">
                <h2>æœ¬æ—¥ã®åˆ¤å®šçµæœ</h2>
                <div class="status-display">
                    <span id="status-icon">Checking...</span>
                    <span id="status-text">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­</span>
                </div>
                <div class="timestamp">æ›´æ–°æ—¥æ™‚: <span id="updated-at">--</span></div>
            </div>

            <div class="details-grid">
                <div class="card detail-card">
                    <h3>é™æ°´é‡ <span id="precip-loc-name" style="font-size: 0.8em; font-weight: normal;"></span></h3>
                    <div class="data-row">
                        <span>å‰3æ—¥ (ç¢ºå®šå€¤)</span>
                        <span class="value" id="p3d-val">-- mm</span>
                    </div>
                    <div class="data-row">
                        <span>å‰30æ—¥ (ç¢ºå®šå€¤)</span>
                        <span class="value" id="p30d-val">-- mm</span>
                    </div>
                </div>

                <div class="card detail-card">
                    <h3>æ°—è±¡æ³¨æ„å ± <span id="warning-loc-name" style="font-size: 0.8em; font-weight: normal;"></span></h3>
                    <div class="data-row">
                        <span>ä¹¾ç‡¥æ³¨æ„å ±</span>
                        <span class="value" id="dry-val">--</span>
                    </div>
                    <div class="data-row">
                        <span>å¼·é¢¨æ³¨æ„å ±</span>
                        <span class="value" id="wind-val">--</span>
                    </div>
                </div>
            </div>

            <div class="notice-box">
                <p><strong>ã€åˆ¤å®šåŸºæº–ã€‘</strong><br>
                    ãƒ»<strong>æ³¨æ„ãƒ¬ãƒ™ãƒ«</strong>: (å‰3æ—¥é›¨é‡â‰¤1mm ã‹ã¤ å‰30æ—¥é›¨é‡â‰¤30mm) ã¾ãŸã¯ (å‰3æ—¥é›¨é‡â‰¤1mm ã‹ã¤ ä¹¾ç‡¥æ³¨æ„å ±ç™ºè¡¨ä¸­)<br>
                    ãƒ»<strong>è­¦å ±ãƒ¬ãƒ™ãƒ«</strong>: æ³¨æ„ãƒ¬ãƒ™ãƒ« ã‹ã¤ å¼·é¢¨æ³¨æ„å ±ç™ºè¡¨ä¸­
                </p>
                <p class="small" id="notes-content">â€»æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯æ°—è±¡åºå…¬å¼ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«è‡ªå‹•åˆ¤å®šã—ã¦ã„ã¾ã™ãŒã€æœ€çµ‚çš„ãªåˆ¤æ–­ã¯å„ç½²æ‰€ã®é‹ç”¨ã«å¾“ã£ã¦ãã ã•ã„ã€‚</p>
            </div>
            <!-- New Section: Trends and Calendar -->
            <div class="analysis-section" style="margin-top: 30px;">
                <div class="card">
                    <h3>ğŸ“Š ä¹¾ç‡¥æŒ‡æ•°ã®æ¨ç§» (30æ—¥é›¨é‡)</h3>
                    <div class="chart-container" style="position: relative; height:30vh; width:100%">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>ğŸ“… æœˆé–“ãƒªã‚¹ã‚¯å®Ÿç¸¾</h3>
                    <div id="calendar-controls"
                        style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                        <button id="prev-month" class="btn-sm">â—€</button>
                        <span id="calendar-title" style="font-weight:bold; font-size:1.1em;"></span>
                        <button id="next-month" class="btn-sm">â–¶</button>
                    </div>
                    <div id="calendar-grid" class="calendar-grid">
                        <!-- Calendar generates here -->
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Locate data source
            let dataMap = null;
            if (window.WEATHER_DATA_MAP) {
                dataMap = window.WEATHER_DATA_MAP;
                initApp(dataMap);
            } else if (window.WEATHER_DATA) {
                dataMap = { 'kitakyushu': window.WEATHER_DATA };
                initApp(dataMap);
            } else {
                fetch('data.json')
                    .then(response => {
                        if (!response.ok) throw new Error("Data not found");
                        return response.json();
                    })
                    .then(data => data.updated_at && data.level !== undefined ? initApp({ 'legacy': data }) : initApp(data))
                    .catch(error => {
                        console.warn('Fetch error:', error);
                        document.getElementById('status-text').textContent = "ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¤±æ•—";
                        document.getElementById('status-icon').textContent = "âŒ";
                    });
            }

            // Load History for Graph & Calendar
            loadHistory();
        });

        // --- Existing UI Logic ---
        function initApp(map) {
            const select = document.getElementById('location-select');
            select.innerHTML = '';
            const keys = Object.keys(map);
            if (keys.length === 0) return;

            keys.forEach(key => {
                const data = map[key];
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = data.label || key;
                select.appendChild(opt);
            });

            if (map['kitakyushu']) select.value = 'kitakyushu';
            else select.value = keys[0];

            select.addEventListener('change', (e) => {
                if (map[e.target.value]) updateUI(map[e.target.value]);
            });
            updateUI(map[select.value]);
        }

        function updateUI(data) {
            const resultCard = document.getElementById('result-card');
            const statusText = document.getElementById('status-text');
            const statusIcon = document.getElementById('status-icon');

            document.getElementById('precip-loc-name').textContent = `(${data.label || 'æŒ‡å®šãªã—'})`;
            document.getElementById('warning-loc-name').textContent = `(${data.label || 'æŒ‡å®šãªã—'}å‘¨è¾º)`;
            document.getElementById('updated-at').textContent = data.updated_at;

            resultCard.classList.remove('loading', 'level-0', 'level-1', 'level-2');
            resultCard.classList.add(`level-${data.level}`);

            statusText.textContent = data.result_text;
            if (data.level === 0) statusIcon.textContent = "âœ”";
            else if (data.level === 1) statusIcon.textContent = "âš ";
            else if (data.level === 2) statusIcon.textContent = "ğŸš¨";

            const p3d = parseFloat(data.p3d).toFixed(1);
            const p3dVal = document.getElementById('p3d-val');
            p3dVal.textContent = `${p3d} mm`;
            p3dVal.classList.toggle('alert-val', parseFloat(data.p3d) <= 1.0);

            const p30d = parseFloat(data.p30d).toFixed(1);
            const p30dVal = document.getElementById('p30d-val');
            p30dVal.textContent = `${p30d} mm`;
            p30dVal.classList.toggle('alert-val', parseFloat(data.p30d) <= 30.0);

            setBooleanStatus('dry-val', data.is_dry);

            const windEl = document.getElementById('wind-val');
            // Support both old boolean and new text
            const windText = data.wind_text || (data.is_strong_wind ? "ç™ºè¡¨ä¸­" : "ãªã—");
            const isActive = data.is_strong_wind || (data.wind_text && data.wind_text !== "ãªã—");

            windEl.textContent = windText;
            windEl.classList.toggle('active-warning', isActive);

            if (data.notes) {
                const notesEl = document.getElementById('notes-content');
                notesEl.innerHTML = `â€»æœ€çµ‚çš„ãªåˆ¤æ–­ã¯å„ç½²æ‰€ã®é‹ç”¨ã«å¾“ã£ã¦ãã ã•ã„ã€‚<br><small style="color:#999;">(${data.notes})</small>`;
            }
        }

        function setBooleanStatus(id, value) {
            const el = document.getElementById(id);
            if (value) {
                el.textContent = "ç™ºè¡¨ä¸­";
                el.classList.add('active-warning');
            } else {
                el.textContent = "ãªã—";
                el.classList.remove('active-warning');
            }
        }

        // --- New Logic: Graph & Calendar ---
        let historyData = [];
        let currentCalDate = new Date();

        function loadHistory() {
            fetch('history.json')
                .then(r => {
                    if (!r.ok) throw new Error("No history");
                    return r.json();
                })
                .then(data => {
                    historyData = data;
                    renderChart(data);
                    renderCalendar(currentCalDate);
                })
                .catch(e => {
                    console.log("History load failed:", e);
                    // Mock data or empty
                    document.getElementById('calendar-grid').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                });
        }

        // 1. Chart
        function renderChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            // Group by date (take last entry per day)
            const daily = {};
            data.forEach(row => {
                daily[row.date] = row;
            });
            const dates = Object.keys(daily).sort().slice(-30); // Last 30 days
            const labels = dates.map(d => d.slice(5)); // mm-dd
            const p30dVals = dates.map(d => daily[d].p30d);
            const p3dVals = dates.map(d => daily[d].p3d);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å‰30æ—¥é›¨é‡(mm)',
                            data: p30dVals,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'å‰3æ—¥é›¨é‡(mm)',
                            data: p3dVals,
                            borderColor: '#2ecc71',
                            borderDash: [5, 5],
                            fill: false,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'é›¨é‡ (mm)' }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 30,
                                    yMax: 30,
                                    borderColor: 'rgba(231, 76, 60, 0.5)',
                                    borderWidth: 2,
                                    label: { content: 'è­¦æˆ’ãƒ©ã‚¤ãƒ³(30mm)', enabled: true }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 2. Calendar
        document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

        function changeMonth(delta) {
            currentCalDate.setMonth(currentCalDate.getMonth() + delta);
            renderCalendar(currentCalDate);
        }

        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            document.getElementById('calendar-title').textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0=Sun

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Headers
            const weeks = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            weeks.forEach(w => {
                const el = document.createElement('div');
                el.className = 'cal-header';
                el.textContent = w;
                grid.appendChild(el);
            });

            // Empty pre-slots
            for (let i = 0; i < startingDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Days
            // Map history to map[YYYY-MM-DD] = max_level
            const historyMap = {};
            historyData.forEach(row => {
                const dayLevel = parseInt(row.level || 0);
                // If multiple entries, take worst(highest) level
                if (!historyMap[row.date] || dayLevel > historyMap[row.date]) {
                    historyMap[row.date] = dayLevel;
                }
            });

            for (let d = 1; d <= daysInMonth; d++) {
                const el = document.createElement('div');
                el.className = 'cal-day';
                el.textContent = d;

                // Check status
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                if (historyMap[dateStr] !== undefined) {
                    const l = historyMap[dateStr];
                    el.classList.add(`level-${l}`);
                    // Add tooltip or symbol
                    const symbol = l === 2 ? 'ğŸš¨' : (l === 1 ? 'âš ' : 'âœ”');
                    const badge = document.createElement('span');
                    badge.textContent = symbol;
                    badge.style.display = 'block';
                    badge.style.fontSize = '0.8em';
                    el.appendChild(badge);
                }

                // Highlight today
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                    el.style.border = '2px solid #333';
                }

                grid.appendChild(el);
            }
        }
    </script>
</body>

</html>